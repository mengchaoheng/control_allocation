# About
 This project refers to the `control_allocation_lib` of [control allocation library](https://github.com/mengchaoheng/control_allocation.git) , especially the code of [ simulation of the book "aircraft control allocation"](https://github.com/mengchaoheng/aircraft-control-allocation), and using C++ to implement the LP-based control allocation algorithm.
 ## Dependencies
 This project depends on [PX4-matrix](https://github.com/mengchaoheng/PX4-Matrix.git). PX4-matrix is a submodule of this project now. If you want to apply these algorithms to your project, please clone the PX4-matrix library to your project first, and copy `alloc_cpp/src/ControlAllocation/ControlAllocation.h` to the project , just include ControlAllocation.h when using it.
### download alglib (option)
If you want to test the algorithm based alglib, download and Unzip alglib to the root folder of this project. rename as `alglib`. 

## Build and run
To get input data:

1. Run `plot_fly_log_states.m` to get the `flight.mat` file.

2. Run `Generate_input_data.m` t get input data `input.csv`.
 and then 
```sh
cd build
cmake ..
make 
```

cd to build path, and run
```sh
./main ## or other target: matlab_code_gen_LPwrap_test, Eingen_based_simplex, alglib_based_minlp_basic.
```
then the main target will write data to `output.csv`, and you can run the `test.m` to compare the output to that generate by matlab code.
## Usage
1. Initialize an aircraft object and allocator object.
```C++
Aircraft<3, 4> df_4(_B, -0.3491, 0.3491); // Create an aircraft object with 4 steering vectors and 3 generalized moments
DP_LP_ControlAllocator<3, 4> Allocator(df_4); // Create a control distributor object for an aircraft with 4 steering vectors and 3 generalized moments (translated into a linear programming problem with dimensions related to parameters <3, 4>.)
```
2. After the input is updated, execute `Allocator.DP_LPCA(input, u, err)`, or `Allocator.allocateControl`, `Allocator.DPscaled_LPCA` for example.

## Test report

### Running time test on MacOS

1. Eigen based:
```
DPscaled_LPCA execution time: 2.0875e-05s
DP_LPCA execution time: 3.5875e-05s
```

2. The Matrix lib of px4 based:
```
Allocator.allocateControl Average execution time: 7.1138e-07s
Allocator.DPscaled_LPCA Average execution time: 5.03832e-07s
Allocator.DP_LPCA Average execution time: 1.50543e-06s
allocator_dir_LPwrap_4 Average execution time: 1.41764e-06s
```

### Running on pixhawk

allocate the input[3]={0.14,  0.02,   -0.11}, the running time is (us):
```sh
INFO  [mixer_module] allocateControl time: 92 
INFO  [mixer_module] DPscaled_LPCA time: 52 
INFO  [mixer_module] DP_LPCA time: 210 
INFO  [mixer_module] allocator_dir_LPwrap_4 time: 26 
## for compare, the running time of older version dir_alloc_sim which generated by matlab and general inversion method:
INFO  [mixer_module] dir_alloc_sim time: 438 
INFO  [mixer_module] inv time: 2 
```
For DPscaled_LPCA, allocate the controller output:
```
INFO  [mixer_module] _u: u1: 0.018821, u2: -0.013027, u3: -0.018821, u4: 0.016198. 
INFO  [mixer_module] alloc time: 58 

INFO  [mixer_module] _u: u1: 0.018770, u2: -0.013203, u3: -0.018770, u4: 0.016466. 
INFO  [mixer_module] alloc time: 54 

INFO  [mixer_module] _u: u1: 0.018950, u2: -0.013131, u3: -0.018950, u4: 0.016430. 
INFO  [mixer_module] alloc time: 73 

INFO  [mixer_module] _u: u1: 0.018739, u2: -0.013269, u3: -0.018739, u4: 0.016374. 
INFO  [mixer_module] alloc time: 83 

INFO  [mixer_module] _u: u1: 0.018813, u2: -0.013122, u3: -0.018813, u4: 0.016479. 
INFO  [mixer_module] alloc time: 57 

INFO  [mixer_module] _u: u1: 0.018853, u2: -0.013315, u3: -0.018853, u4: 0.016498. 
INFO  [mixer_module] alloc time: 90 

INFO  [mixer_module] _u: u1: 0.018830, u2: -0.013456, u3: -0.018830, u4: 0.016391. 
INFO  [mixer_module] alloc time: 57 

INFO  [mixer_module] _u: u1: 0.018683, u2: -0.013359, u3: -0.018683, u4: 0.016193. 
INFO  [mixer_module] alloc time: 54 

INFO  [mixer_module] _u: u1: 0.018837, u2: -0.013617, u3: -0.018837, u4: 0.016337. 
INFO  [mixer_module] alloc time: 53 

INFO  [mixer_module] _u: u1: 0.018860, u2: -0.013602, u3: -0.018860, u4: 0.016481. 
INFO  [mixer_module] alloc time: 69 

INFO  [mixer_module] _u: u1: 0.018594, u2: -0.013613, u3: -0.018594, u4: 0.016411. 
INFO  [mixer_module] alloc time: 63 

INFO  [mixer_module] _u: u1: 0.018476, u2: -0.013895, u3: -0.018476, u4: 0.016637. 
INFO  [mixer_module] alloc time: 55 

INFO  [mixer_module] _u: u1: 0.018620, u2: -0.014007, u3: -0.018620, u4: 0.016550. 
INFO  [mixer_module] alloc time: 55 

INFO  [mixer_module] _u: u1: 0.018479, u2: -0.013912, u3: -0.018479, u4: 0.016500. 
INFO  [mixer_module] alloc time: 73 
```